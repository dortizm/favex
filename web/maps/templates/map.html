<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  #app { position: relative; height: 100vh; width: 100vw; overflow: hidden; }
  #map { position: absolute; inset: 0; }

  /* Panel izquierdo */
  #filter-panel{
    position: absolute;
    top: 12px;
    left: 12px;              /* <-- izquierda */
    width: 280px;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 12px 12px 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    z-index: 2;
  }
  #filter-panel h3{ margin: 0 0 10px; font-size: 16px; }
  #filter-panel label{ display:block; margin-top:10px; font-size: 12px; opacity: .85; }
  #filter-panel select, #filter-panel button{
    width: 100%;
    margin-top: 6px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,.15);
    background: white;
  }
  #filter-panel button{
    margin-top: 12px;
    cursor: pointer;
  }
  #filter-panel .hint{
    margin-top: 10px;
    font-size: 12px;
    opacity: .7;
    line-height: 1.25;
  }

  .sidebar{
    position: absolute;
    top: 0; right: 0;
    width: 360px;
    height: 100%;
    background: #fff;
    border-left: 1px solid #e5e5e5;
    box-shadow: -6px 0 18px rgba(0,0,0,.08);
    padding: 14px 14px 10px;
    z-index: 2;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .sidebar__header{
    display: flex; align-items: center; justify-content: space-between;
    gap: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px; margin-bottom: 10px;
  }
  .sidebar__header h3{ margin: 0; font-size: 16px; }
  .sidebar__content{ font-size: 13px; line-height: 1.35; }
  .muted{ color: #666; margin: 0; }
  .btn{
    border: 1px solid #ddd; background: #fafafa;
    padding: 6px 10px; border-radius: 8px; cursor: pointer;
  }
  .row{ display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; margin: 10px 0; }
  .kv{ padding: 8px; border: 1px solid #eee; border-radius: 10px; background: #fcfcfc; }
  .k{ font-size: 11px; color:#666; }
  .v{ font-size: 13px; font-weight: 600; word-break: break-word; }
</style>
<div id="app">
  <div id="map" style="height:100vh"></div>

  <!-- Panel de filtros izquierda -->
  <div id="filter-panel">
    <h3>Filtros</h3>

    <label>Región</label>
    <select id="sel-region">
      <option value="">Todas</option>
    </select>

    <label>Provincia</label>
    <select id="sel-provincia" disabled>
      <option value="">Todas</option>
    </select>

    <label>Comuna</label>
    <select id="sel-comuna" disabled>
      <option value="">Todas</option>
    </select>

    <button id="btn-clear" type="button">Limpiar</button>
  </div>
  <!-- Sidebar derecho -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar__header">
      <h3>Selección</h3>
      <button id="btnClear" class="btn">Limpiar</button>
    </div>

    <div id="sidebarContent" class="sidebar__content">
      <p class="muted">Haz click en un hexágono para ver detalles.</p>
    </div>
  </aside>
</div>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<script>

  function setOptionsFromPairs(selectEl, pairs, includeAll=true){
    selectEl.innerHTML = "";
    if(includeAll) selectEl.append(new Option("Todas", ""));
    pairs.forEach(({code, name}) => selectEl.append(new Option(name, String(code))));
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  const map = new maplibregl.Map({
    container: "map",
    style: "/mvt/style.json",
    center: [-70.65, -33.45],
    zoom: 6
  });

  map.addControl(new maplibregl.NavigationControl());

  map.on("load", async () => {
    // === DOM selects ===
    const selRegion = document.getElementById("sel-region");
    const selProv   = document.getElementById("sel-provincia");
    const selCom    = document.getElementById("sel-comuna");
    const btnClear  = document.getElementById("btn-clear");

    // === Sidebar DOM ===
    const sidebarContent = document.getElementById("sidebarContent");
    const btnClearSel    = document.getElementById("btnClear");

    // === CONFIG: style.json ===
    // 1) El "source" que contiene tus tiles (en style.json -> sources -> <id>)
    const SOURCE_ID = "tegola";     // <-- cambia si tu source se llama distinto
    // 2) El "source-layer" dentro del tile (nombre de capa MVT; en Tegola suele ser el name del provider_layer)
    const SOURCE_LAYER = "hex5km";  // <-- cambia si tu capa se llama distinto
    // =================================================

    // Si style.json NO trae el source, puedes agregarlo aquí (descomenta y ajusta URL):
    /*
    if (!map.getSource(SOURCE_ID)) {
      map.addSource(SOURCE_ID, {
        type: "vector",
        tiles: ["http://localhost:9090/maps/base/{z}/{x}/{y}.pbf"], // ajusta
        minzoom: 0,
        maxzoom: 14
      });
    }
    */

    // 1) Agrega una capa fill con gradiente semáforo basado en id_hex (1..39735)
    // La insertamos antes de la primera capa de símbolos, para no tapar labels (si existen).
    const firstSymbolLayerId = (map.getStyle().layers || []).find(l => l.type === "symbol")?.id;

    // Fill semáforo + highlight con feature-state (Evita duplicar si recargas estilo) 
    if (!map.getLayer("hex5km-fill-semaforo")) {
      map.addLayer(
        {
          id: "hex5km-fill-semaforo",
          type: "fill",
          source: SOURCE_ID,
          "source-layer": SOURCE_LAYER,
          paint: {
            "fill-color": [
              "interpolate",
              ["linear"],
              ["to-number", ["coalesce", ["get", "id_hex"], 1]],
              1, "#00c853",        // verde
              19868, "#ffeb3b",    // amarillo (mitad)
              39735, "#d50000"     // rojo
            ],
            "fill-opacity": 0.55
          }
        },
        firstSymbolLayerId // beforeId (puede ser undefined; igual funciona)
      );
    }

    // Line borde + highlight con feature-state (Opcional) borde del hex para que se vea más claro
    if (!map.getLayer("hex5km-line")) {
      map.addLayer(
        {
          id: "hex5km-line",
          type: "line",
          source: SOURCE_ID,
          "source-layer": SOURCE_LAYER,
          paint: {
            "line-color": "rgba(0,0,0,0.35)",
            "line-width": 0.8
          }
        },
        firstSymbolLayerId
      );
    }

    // =========================
    // CARGA DE SELECTS + FILTRO
    // =========================
    // Capa(s) a filtrar
    const FILTER_LAYERS = ["hex5km-fill-semaforo", "hex5km-line"];

    // Capa(s) clickeables: usa solo las del hex (evita clicks en todo el style)
    const CLICK_LAYERS = ["hex5km-fill-semaforo", "hex5km-line"];

    // =========================
    // Sidebar render
    // =========================
    function renderSelection(props = null) {
      if (!props) {
        sidebarContent.innerHTML = `<p class="muted">Haz click en un hexágono para ver detalles.</p>`;
        return;
      }

      // Ajusta/expande estos campos a tu gusto
      const fields = [
        ["id_hex", props.id_hex],
        ["cut_reg", props.cut_reg],
        ["cut_prov", props.cut_prov],
        ["cut_com", props.cut_com],
        ["region", props.region],
        ["provincia", props.provincia],
        ["comuna", props.comuna],
      ].filter(([k, v]) => v !== undefined && v !== null && v !== "");

      sidebarContent.innerHTML = `
        <div class="row">
          ${fields.map(([k, v]) => `
            <div class="kv">
              <div class="k">${escapeHtml(k)}</div>
              <div class="v">${escapeHtml(v)}</div>
            </div>
          `).join("")}
        </div>
        <details>
          <summary>Ver JSON completo</summary>
          <pre style="white-space:pre-wrap; font-size:12px; border:1px solid #eee; padding:10px; border-radius:10px; background:#fafafa;">${escapeHtml(JSON.stringify(props, null, 2))}</pre>
        </details>
      `;
    }

    // =========================
    // feature-state selection
    // =========================
    let selected = null; // { source, sourceLayer, id }

    function clearSelected() {
      if (selected) {
        map.setFeatureState(selected, { selected: false });
      }
      selected = null;
      renderSelection(null);
    }

    btnClearSel.addEventListener("click", clearSelected);

    // =========================
    // FILTRO
    // =========================

    function applyHexFilter(){
      const cut_reg  = selRegion.value;
      const cut_prov = selProv.value;
      const cut_com  = selCom.value;

      const clauses = ["all"];
      if (cut_reg)  clauses.push(["==", ["to-string", ["get", "cut_reg"]],  String(cut_reg)]);
      if (cut_prov) clauses.push(["==", ["to-string", ["get", "cut_prov"]], String(cut_prov)]);
      if (cut_com)  clauses.push(["==", ["to-string", ["get", "cut_com"]],  String(cut_com)]);

      const expr = clauses.length > 1 ? clauses : null;

      FILTER_LAYERS.forEach(layerId => {
        if (map.getLayer(layerId)) map.setFilter(layerId, expr);
      });
    }


    async function fetchJSON(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error("HTTP " + res.status + " en " + url);
      return await res.json();
    }

    async function loadRegions(){
      const regions = await fetchJSON("/api/regions/");
      setOptionsFromPairs(selRegion, regions);
    }

    async function loadProvinces(cut_reg){
      const provs = await fetchJSON("/api/provinces/?cut_reg=" + encodeURIComponent(cut_reg));
      setOptionsFromPairs(selProv, provs);
    }

    async function loadCommunes(cut_reg, cut_prov){
      const coms = await fetchJSON(
        "/api/communes/?cut_reg=" + encodeURIComponent(cut_reg) +
        "&cut_prov=" + encodeURIComponent(cut_prov)
      );
      setOptionsFromPairs(selCom, coms);
    }

    // Inicializa regiones
    await loadRegions().catch(console.error);

    // listeners cascada
    selRegion.addEventListener("change", async () => {
      const cut_reg = selRegion.value;

      selProv.disabled = !cut_reg;
      selCom.disabled  = true;

      setOptionsFromPairs(selProv, []);
      setOptionsFromPairs(selCom, []);

      if (cut_reg) await loadProvinces(cut_reg);

      applyHexFilter();
    });

    selProv.addEventListener("change", async () => {
      const cut_reg  = selRegion.value;
      const cut_prov = selProv.value;

      selCom.disabled = !(cut_reg && cut_prov);
      setOptionsFromPairs(selCom, []);

      if (cut_reg && cut_prov) await loadCommunes(cut_reg, cut_prov);

      applyHexFilter();
    });

    selCom.addEventListener("change", () => applyHexFilter());

    btnClear.addEventListener("click", () => {
      selRegion.value = "";
      selProv.value = "";
      selCom.value = "";

      selProv.disabled = true;
      selCom.disabled = true;

      setOptionsFromPairs(selProv, []);
      setOptionsFromPairs(selCom, []);

      FILTER_LAYERS.forEach(layerId => {
        if (map.getLayer(layerId)) map.setFilter(layerId, null);
      });
    });


    // =========================
    // Click + mousemove 
    // =========================

    map.on("click", (e) => {
      const z = map.getZoom();
      const pad = Math.round(Math.min(300, Math.max(50, z * 5))); // 6..20 px aprox

      const bbox = [
        [e.point.x - pad, e.point.y - pad],
        [e.point.x + pad, e.point.y + pad],
      ];

      const features = map.queryRenderedFeatures(bbox, { layers: CLICK_LAYERS });
      if (!features.length) return;

      // Preferir el fill para evitar duplicados line+fill
      const f = features.find(x => x.layer && x.layer.id === "hex5km-fill-semaforo") || features[0];

      // 1) Sidebar con properties
      renderSelection(f.properties || {});

      // 2) Highlight con feature-state si existe id
      if (f.id != null) {
        if (selected) map.setFeatureState(selected, { selected: false });

        selected = {
          source: f.source,
          sourceLayer: f.sourceLayer,
          id: f.id,
        };
        map.setFeatureState(selected, { selected: true });
      } else {
        // Sin id, no se puede feature-state
        selected = null;
      }

      // 3) Popup (opcional)
      const idHex = f.properties?.id_hex ?? "(sin id_hex)";
      new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`<b>id_hex:</b> ${escapeHtml(idHex)}`)
        .addTo(map);

      console.log("clicked layer:", f.layer?.id, "id_hex:", idHex, "feature:", f);
    });

    map.on("mousemove", (e) => {
      const feats = map.queryRenderedFeatures(e.point, { layers: CLICK_LAYERS });
      map.getCanvas().style.cursor = feats.length ? "pointer" : "";
    });
  });
</script>
